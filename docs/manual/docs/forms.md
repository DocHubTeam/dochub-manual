# Формы (forms)

Подход "Архитектура как код" не всегда оказывается удобным для пользователей архитектурного репозитория. 
Привыкшие к классическим UI-интерфейсам пользователи, могут столкнуться с трудностями при взаимодействии
с архитектурным репозиторием на первом этапе. Чтобы облегчить их опыт и предложить привычные методы работы
с репозиторием, по крайней мере на начальном этапе, DocHub предлагает динамические UI-формы.

## Простой пример динамической формы

Пример описания формы:
```yaml
docs:
  dochub.forms.examples.simple:                       # Идентификатор документа
    description: Простой пример динамической формы    # Описание документа
    type: form                                        # Тип определяющий динамическую форму
    source:                                           # Данные для построения формы
      schema:                                         # JSONSchema
        type: object
        title: Тестовая форма заполнения данных о пользователе
        properties:
          first_name:
            title: Имя
            type: string
          last_name:
            title: Фамилия
            type: string
          address:
            title: Адрес регистрации
            type: string
        required:
          - first_name
          - last_name
          - address  
```

Данная форма позволяет заполнять данные о пользователе в привычной для него форме. В текущем виде она не позволяет сохранять 
введенные данные или манипулировать ими, но мы можем посмотреть как работает ввод и проверка корректности ее заполнения.

Встраивание формы в документы осуществляется обычным методом встройки объектов:
```
![Форма](@document/dochub.forms.examples.simple)
```



Результат встройки выглядит так:
![Форма](@document/dochub.forms.examples.simple)

## Пример формы с алгоритмом поведения

Формы могут выполнять действия по триггерам. Обработчики триггеров реализуются на JSONata. При наступлении события
вызывается соответствующий обработчик, в который передаются необходимые переменные:

* **\$**                      - DataLake.
* **\$self**                  - профиль презентации;
* **\$params**                - переданные параметры при вызове презентации;
* **\$params.\$form**         - данные формы;
* **\$params.\$form.data**    - заполненные данные формы;
* **\$params.\$form.changes** - пути к измененным свойствам.

Существуют следующие триггеры:

* **change**     - вызывается при изменении значения одного из полей;
* **validate**   - вызывается после заполнения формы для проверки на ошибки;
* **post**       - вызывается при нажатии кнопки сохранения;
* **init**       - вызывается в момент создания формы.

### Триггер change

Для примера создадим форму сложения двух чисел.
```code-frame
docs/dochub.forms.examples.summ
```
![Форма сложения чисел](@document/dochub.forms.examples.summ)

### Триггер validate

Динамические формы имеют встроенную подсистему контроля заполнения формы, которая использует JSONSchema.
Но в некоторых случаях этого недостаточно. Эту проблему можно решить с помощью триггера **validate**.
Он вызывается при завершении заполнения формы, когда данные в ней полностью соответствуют декларированной
JSONSchema.

В будущем мы будем сохранять результат вычисления в DataLake. Представим себе, что корректным для сохранения 
результатом может быть только четное число. Для контроля корректности в форму добавляется триггер **validate**.

```code-frame
docs/dochub.forms.examples.validate
```
В результате работы треггера, если ошибки обнаружены, он должен вернуть структуру или массив структур с описанием
ошибок в следующем формате:
```json
  [
    {
      message: <описание ошибки>,
      path: [<путь к полю с ошибкой>]
    }
    ...
  ]
```

Чтобы увидеть работу триггера в действии необходимо после вычисления результата нажать кнопку "Проверить"/"Validate".

![Форма сложения чисел](@document/dochub.forms.examples.validate)

### Триггер post

Результат работы формы можно сохранять в архитектурном репозитории (DataLake). При сохранении форма генерирует изменения
в архитектурном коде, как если бы это сделал человек. Для реализации этой функции необходимо создать триггер **post**. 

```code-frame
docs/dochub.forms.examples.post
```

В коде мы возвращаем путь "docs/dochub.forms.examples.post/data". Этот путь затрагивает декларацию самой формы, которая
сохраняет данные. При сохранении вы увидите, что код выше изменится, в нем отразится поле "data" с введенными вами
данными. Это наглядная демонстрация того, что сохранение формы приводит к модификации кода репозитория, добавляя в него
поле "data".

![Форма сохранения вычисления в репозитории](@document/dochub.forms.examples.post)

[Далее](/docs/dochub.entities)
